<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="yjc.wdb.mapper.BillMapper">

	<insert id="insertBill">
		insert into BILL
		(USER_ID, BILL_ISSU_DE
		values
		(#{user_id}, now())
	</insert>

	<resultMap id="billOne" type="java.util.HashMap">
		<result property="goods_nm" column="goods_nm" />
		<result property="purchgoods_qy" column="purchgoods_qy" />
		<result property="COUPON_DSCNT" column="COUPON_DSCNT" />
		<result property="price" column="price" />
	</resultMap>

	<resultMap id="recommandProduct" type="java.util.HashMap">
		<result property="goods_code" column="goods_code" />
		<result property="goods_nm" column="goods_nm" />
		<result property="goods_pc" column="goods_pc" />
	</resultMap>

	<resultMap id="settleInfo" type="java.util.HashMap">
		<result property="bill_code" column="bill_code" />
		<result property="setle_mth_code" column="setle_mth_code" />
		<result property="setle_mth_nm" column="setle_mth_nm" />
		<result property="stprc" column="stprc" />
	</resultMap>

	<select id="billList" resultType="BillVO">
		select * from bill where
		user_id = #{user_id} and date(bill.BILL_ISSU_DE) >=
		date(subdate(curDate(), INTERVAL #{day} DAY));
	</select>

	<select id="billOne" resultMap="billOne">
		select g.GOODS_NM as goods_nm,
		pg.PURCHSGOODS_QY as purchgoods_qy, if(isnull(pg.COUPON_CODE), 'X',
		c.COUPON_DSCNT) as COUPON_DSCNT, g.GOODS_PC *
		pg.PURCHSGOODS_QY -
		if(isnull(pg.COUPON_CODE), 0, if(c.COUPON_DSCNT like '%@%' escape '@',
		g.GOODS_PC * (trim(trailing '%' from c.COUPON_DSCNT)/100),
		c.COUPON_DSCNT)) as price
		from goods g, purchase_goods pg, bill b,
		coupon c
		where g.GOODS_CODE = pg.GOODS_CODE and pg.BILL_CODE =
		b.BILL_CODE and
		if(isnull(pg.COUPON_CODE), 1, c.COUPON_CODE =
		pg.COUPON_CODE) and b.BILL_CODE = #{bill_code}
		group by g.GOODS_NM,
		pg.bill_code;
	</select>

	<select id="settleInfo" resultMap="settleInfo">
		select b.BILL_CODE as
		bill_code, sm.setle_mth_code as setle_mth_code, sm.setle_mth_nm as
		setle_mth_nm, si.stprc as stprc
		from bill b, settlement_method sm,
		settlement_infomation si
		where b.user_id = #{user_id} and
		sm.setle_mth_code = si.setle_mth_code and b.BILL_CODE = si.bill_code
		and b.bill_code = #{bill_code}
		order by b.bill_code;
	</select>


	<select id="recommandProduct" resultMap="recommandProduct">
		select
		g.GOODS_CODE as
		goods_code, g.GOODS_NM as goods_nm, g.GOODS_PC as goods_pc
		from
		purchase_goods pg, goods g, user u, bill b
		where g.GOODS_CODE =
		pg.GOODS_CODE and u.user_id = b.user_id and
		pg.BILL_CODE = b.BILL_CODE
		and
		floor((year(curDate()) - date_format(u.USER_BRTHDY, '%Y') + 1)/10)
		=
		(select floor((year(curDate()) - date_format(user.USER_BRTHDY, '%Y')
		+ 1)/10)
		from
		user where user_id = #{user_id}) and
		u.USER_SEXDSTN =
		(select
		user.USER_SEXDSTN from user where user_id = #{user_id}) and
		u.USER_MRRG_AT = (select user.USER_MRRG_AT from user where user_id =
		#{user_id})
		group by g.GOODS_CODE, u.USER_SEXDSTN,
		floor((year(curDate()) - date_format(u.USER_BRTHDY, '%Y') + 1)/10)
		order by sum(pg.PURCHSGOODS_QY) desc
		limit 0, 10
	</select>

	<!-- 매출 -->
	<resultMap id="yearSales" type="java.util.HashMap">
		<result property="year" column="year" />
		<result property="totalPrice" column="totalPrice" />
	</resultMap>

	<resultMap id="settleSalesInfo" type="java.util.HashMap">
		<result property="year" column="year" />
		<result property="setle_mth_nm" column="setle_mth_nm" />
		<result property="totalPrice" column="totalPrice" />
	</resultMap>

	<resultMap id="daySales" type="java.util.HashMap">
		<result property="bill_issu_de" column="bill_issu_de" />
		<result property="totalPrice" column="totalPrice" />

	</resultMap>

	<select id="yearSales" resultMap="yearSales">
		select
		date_format((b.BILL_ISSU_DE), '%Y') as year, sum(b.BILL_TOTAMT) as
		totalPrice
		from bill b
		where
		(
		b.BILL_ISSU_DE like concat(#{year}, '%')
		or
		b.BILL_ISSU_DE like concat(#{year}-1, '%')
		or b.BILL_ISSU_DE like
		concat(#{year}-2, '%')
		or b.BILL_ISSU_DE like concat(#{year}-3, '%')
		or
		b.BILL_ISSU_DE like concat(#{year}-4, '%')
		)
		group by
		date_format((b.BILL_ISSU_DE), '%Y');


	</select>

	<select id="searchYear" resultMap="yearSales">
		<![CDATA[
		select
		date_format((b.BILL_ISSU_DE), '%Y') as year, sum(b.BILL_TOTAMT) as
		totalPrice
		from bill b
		where date_format((b.BILL_ISSU_DE), '%Y') between #{year1} and #{year2}
		group by date_format((b.BILL_ISSU_DE), '%Y');
		]]>

	</select>

	<select id="settleSalesInfo" resultMap="settleSalesInfo">
		<![CDATA[
		select
			date_format((b.BILL_ISSU_DE), '%Y') as year, sm.setle_mth_nm as setle_mth_nm, 
			sum(si.stprc) as totalPrice
			from bill b, settlement_infomation si, settlement_method sm
			where date_format((b.BILL_ISSU_DE), '%Y') between #{year1} and #{year2} 		
			and b.BILL_CODE = si.bill_code and sm.setle_mth_code = si.setle_mth_code
			group by date_format((b.BILL_ISSU_DE), '%Y'), sm.setle_mth_code;
		]]>

	</select>



	<select id="daySales" resultMap="daySales">
		<![CDATA[
		select b.BILL_ISSU_DE
		as bill_issu_de, sum(b.BILL_TOTAMT) as
		totalPrice 
		from bill b
		where (b.BILL_ISSU_DE between subDate(curDate(),
		Interval 7 DAY) and curDate())
		group by b.BILL_ISSU_DE;
		]]>
	</select>


	<select id="daySalesSettleInfo" resultMap="settleSalesInfo">
	
	<![CDATA[
	select
		b.BILL_ISSU_DE as year, sm.setle_mth_nm as setle_mth_nm, 
		sum(si.stprc) as totalPrice
		from bill b, settlement_infomation si, settlement_method sm
		where b.BILL_ISSU_DE between subDate(curDate(),
		Interval 7 DAY) and curDate() and 
		b.BILL_CODE = si.bill_code and sm.setle_mth_code = si.setle_mth_code
		group by b.BILL_ISSU_DE, sm.setle_mth_code;
	]]>
	</select>


	<select id="searchDaySales" resultMap="daySales">
	<![CDATA[
		select b.BILL_ISSU_DE
			as bill_issu_de, sum(b.BILL_TOTAMT) as
			totalPrice from
			bill b
			where (b.BILL_ISSU_DE between #{date2} and #{date1})
			group by
			b.BILL_ISSU_DE;
	]]>

	</select>


	<select id="daySettle" resultMap="settleSalesInfo">
		<![CDATA[
		select
		b.BILL_ISSU_DE as year, sm.setle_mth_nm as setle_mth_nm, 
		sum(si.stprc) as totalPrice
		from bill b, settlement_infomation si, settlement_method sm
		where b.BILL_ISSU_DE between #{date2} and #{date1} and 
		b.BILL_CODE = si.bill_code and sm.setle_mth_code = si.setle_mth_code and
		sm.setle_mth_code = #{setle_mth_code}
		group by b.BILL_ISSU_DE, sm.setle_mth_code;
		]]>
	</select>


	<select id="monthSales" resultMap="daySales">
	<![CDATA[
		select date_format(b.BILL_ISSU_DE, '%Y-%m') as bill_issu_de, sum(b.BILL_TOTAMT) as totalPrice
		from bill b
		where date_format(b.BILL_ISSU_DE, '%Y-%m') between #{month2} and #{month1} and
		group by date_format(b.BILL_ISSU_DE, '%Y-%m')

	]]>

	</select>

	<select id="monthSalesSettleInfo" resultMap="settleSalesInfo">
	<![CDATA[
		
		select date_format(b.BILL_ISSU_DE, '%Y-%m') as year, sm.setle_mth_nm as setle_mth_nm, sum(si.stprc) as totalPrice
		from bill b, settlement_infomation si, settlement_method sm
		where si.bill_code = b.BILL_CODE and sm.setle_mth_code = si.setle_mth_code and
		date_format(b.BILL_ISSU_DE, '%Y-%m') between #{month2} and #{month1}
		and sm.setle_mth_code = #{setle_mth_code}
		group by date_format(b.BILL_ISSU_DE, '%Y-%m'), sm.setle_mth_nm;
	]]>
	</select>



</mapper>